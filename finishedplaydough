#More fun with playdough: Small Empty dataframe manipulations: 
library(tidyverse)
library(data.table)
library(matrixStats)
library(dplyr)
library(moments)

setwd("/Users/caroline/Desktop/srd_github")
smallempty <- fread("FINALsmallempty.csv", header = TRUE)
realdf <- fread("FINALdensitydf.csv", header = TRUE)
#real df has the repeat i column as column 1

#run the same statistical analyses: 
smallempty <- smallempty %>% add_column(new_col = NA, .after=1)
colnames(smallempty)[2] <- "Length of PSU"
smallempty <- smallempty %>% add_column(new_col = NA, .after=1)
colnames(smallempty)[2] <- "Mean Density"
smallempty <- smallempty %>% add_column(new_col = NA, .after=1)
colnames(smallempty) [2] <- "Standard Deviation"

#Mean: 
smallempty$`Mean Density` <- rowMeans(smallempty[ ,-1], na.rm = T)
#SDS: 
smallempty$`Standard Deviation` <- rowSds(as.matrix(smallempty[, -c(1,3)]), na.rm = T)

na_smallempty <- !is.na(smallempty)
#drop the first three columns 
na_smallempty <- na_smallempty[, -c(1:3)] %>% as.data.frame()

#now count the number of true in each row via rowSums(df)
na_smallempty$`Length of PSU` <- rowSums(na_smallempty[, -1])
#input the length back into the original dataframe: 
smallempty$`Length of PSU` <- na_smallempty$`Length of PSU` #length is done

smallempty <- smallempty %>% add_column(new_col = NA, .after =1)
colnames(smallempty)[2] <- "IQR"
smallempty <- smallempty %>% add_column(new_col = NA, .after =1)
colnames(smallempty)[2] <- "Median"
smallempty <- smallempty %>% add_column(new_col = NA, .after =1)
colnames(smallempty)[2] <- "Skewedness"

smallempty$IQR <- rowIQRs(as.matrix(smallempty[ , -c(1,5,6,7)]), na.rm = TRUE)
smallempty$Median <- rowMedians(as.matrix(smallempty[ , -c(1,4,5,6,7)]), na.rm = TRUE)
smallempty$Skewedness <- apply(smallempty[ , -c(1,3,4,5,6,7)], 1, skewness, na.rm =TRUE) 
#smallempty has all spread stats now loaded in 

#Matching up the skewness with the OR (higher OR = more SRD): First, match up the csv.s w/ their associated PSU
#Odds Ratios source from which dataframe again?
setwd("/Users/caroline/Desktop/srd_github")
PSU <- fread("PSUs.csv", header = TRUE)

setwd("/Users/caroline/Downloads/")
threeprimeutr <- fread("3'_UTRs.csv", header = TRUE) #3'utr contains all the stuff we need to match up the mRNA number to the csv, and then the mRNA number to the PSU dataframe

#rename the V1 column into mRNA number: 
colnames(smallempty)[1] <- "mRNA Number"
smallemptyandPSU <- merge(PSU, smallempty, by = "mRNA Number") #437 observations

#well. I still matched up 451 observations, and now I need to match the utrs to a specific gene
#next step: Find the UTRs connected to the same gene, find the median of their UTR expression/stat and assign it to the gene

#For gene names that are the exact same, take the median of the medians of the density analysis for those different UTRs and assign them all to that
#one gene name: 

#for median: 
smallemptyandPSU %>% group_by(`Gene Name`) %>% 
  mutate(median = median(Median)) %>%
  select(`Gene Name`, Median, `WT/KO`) %>%
  unique() -> duplicateremovedmed

ggplot(duplicateremovedmed, aes(x = Median, y = `WT/KO`)) +
  geom_point() + 
  geom_hline(yintercept=1.2)

#for IQR: 
smallemptyandPSU %>% group_by(`Gene Name`) %>% 
  mutate(IQR = mean(IQR)) %>%
  select(`Gene Name`, IQR, `WT/KO`) %>%
  unique() -> duplicateremovediqr

ggplot(duplicateremovediqr, aes(x = IQR, y = `WT/KO`)) +
  geom_point() + 
  geom_hline(yintercept=1.2) #no <3

#mean density: 
smallemptyandPSU %>% group_by(`Gene Name`) %>% 
  mutate(mean = mean(`Mean Density`)) %>%
  select(`Gene Name`,`Mean Density`, `WT/KO`) %>%
  unique() -> duplicateremovedmean

ggplot(duplicateremovedmean, aes(x = `Mean Density`, y = `WT/KO`)) +
  geom_point() + 
  geom_hline(yintercept=1.2) #looks kinda similar to median

#by standard deviation: 
smallemptyandPSU %>% group_by(`Gene Name`) %>% 
  mutate(sd = median(`Standard Deviation`)) %>%
  select(`Gene Name`,`Standard Deviation`, `WT/KO`) %>%
  unique() -> duplicateremovedsd

ggplot(duplicateremovedsd, aes(x = `Standard Deviation`, y = `WT/KO`)) +
  geom_point() + 
  geom_hline(yintercept=1.2) #a little better than mean/median?

#by GC content for fun!
smallemptyandPSU %>% group_by(`Gene Name`) %>% 
  mutate(gc = mean(`GC Percentage`)) %>%
  select(`Gene Name`,`GC Percentage`, `WT/KO`) %>%
  unique() -> duplicateremovedgc

ggplot(duplicateremovedgc, aes(x = `GC Percentage`, y = `WT/KO`)) +
  geom_point() + 
  geom_hline(yintercept=1.2) #interesting, but more like a blob than anything else.

#############################################
smallemptyandPSU %>% group_by(`Gene Name`) %>% 
  mutate(dG = median(`Delta G per Nucleotide`)) %>%
  select(`Gene Name`, dG, `WT/KO`) %>%
  unique() -> duplicateremoved

ggplot(duplicateremoved, aes(x = -dG, y = `WT/KO`)) +
  geom_point() + 
  geom_hline(yintercept=1.2) #his was our reference

#############################################
#Delta G and Median: 
smallemptyandPSU %>% group_by(`Gene Name`) %>% 
  mutate(dG = median(`Delta G per Nucleotide`)) %>%
  mutate(median = median(Median)) %>%
  select(`Gene Name`, dG, `WT/KO`, Median) %>%
  unique() -> duplicateremovedwow
  
ggplot(duplicateremovedwow, aes(x = -dG, y = `Median`)) +
  geom_point() 
